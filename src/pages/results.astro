---
import Layout from '../layouts/Layout.astro';
import trades from '../data/trades.json';
import baseChecklist from '../data/checklists/_base.json';
import tradeSpecific from '../data/checklists/trade-specific.json';
import { Loader2, AlertCircle, Lightbulb, CheckCircle2, ChevronLeft } from '@lucide/astro'

// This page reads from sessionStorage via client JS
// We'll render the structure and hydrate with data

// Lucide icon SVGs for client-side rendering
const icons = {
  megaphone: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 11 18-5v12L3 14v-3z"/><path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"/></svg>',
  dollar: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',
  clipboard: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>',
  wrench: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>',
  users: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
  rocket: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/></svg>'
};

const categoryIconMap = {
  'Marketing': icons.megaphone,
  'Sales': icons.dollar,
  'Admin & Finance': icons.clipboard,
  'Operations': icons.wrench,
  'Customer Experience': icons.users,
  'Advanced (Cutting Edge)': icons.rocket
};

// Pass all data to client via define:vars
const allTrades = trades.trades;
const allBaseCategories = baseChecklist.categories;
const allTradeSpecific = tradeSpecific;
---

<Layout title="Your Assessment Results | AI Automation">
  <main class="max-w-4xl mx-auto px-6 py-12">
    
    <!-- Loading State -->
    <div id="loading" class="text-center py-20">
      <Loader2 class="w-12 h-12 animate-spin mx-auto mb-4 text-cyan-400" />
      <p class="text-paper-200/60">Loading your results...</p>
    </div>

    <!-- Results Content (hidden until loaded) -->
    <div id="results-content" class="hidden">
      
      <!-- Score Header -->
      <div class="text-center mb-12">
        <div class="inline-flex items-center gap-2 dark-card px-4 py-2 mb-6">
          <span id="trade-icon" class="text-2xl"></span>
          <span id="trade-name" class="font-medium text-paper-100"></span>
        </div>
        
        <h1 class="text-4xl md:text-5xl font-extrabold mb-4 text-paper-100">
          Your Score: <span id="score-percent" class="text-cyan-400">0%</span>
        </h1>
        
        <p class="text-xl text-paper-200/70 mb-6">
          You're doing <span id="checked-count" class="text-paper-100 font-semibold">0</span> out of <span id="total-items" class="text-paper-100 font-semibold">0</span> things successful <span id="trade-name-2"></span> businesses do.
        </p>

        <!-- Score Bar -->
        <div class="max-w-md mx-auto">
          <div class="w-full bg-navy-800 rounded-full h-4 mb-2">
            <div id="score-bar" class="progress-cyan h-4 rounded-full transition-all duration-1000" style="width: 0%"></div>
          </div>
          <div class="flex justify-between text-sm text-paper-200/50">
            <span>Needs Work</span>
            <span>Good</span>
            <span>Excellent</span>
          </div>
        </div>
      </div>

      <!-- Grade Card -->
      <div id="grade-card" class="paper-card p-8 text-center mb-12">
        <div id="grade" class="text-6xl font-extrabold mb-2 text-navy-900">C</div>
        <p id="grade-message" class="text-navy-600"></p>
      </div>

      <!-- Critical Gaps -->
      <section id="critical-gaps-section" class="mb-12">
        <h2 class="text-2xl font-bold mb-2 flex items-center gap-3 text-paper-100">
          <AlertCircle class="w-6 h-6 text-red-400" />
          Critical Gaps
        </h2>
        <p class="text-paper-200/60 mb-6">High-impact items you're not doing. Fix these first.</p>
        <div id="critical-gaps" class="space-y-4"></div>
      </section>

      <!-- Quick Wins -->
      <section id="quick-wins-section" class="mb-12">
        <h2 class="text-2xl font-bold mb-2 flex items-center gap-3 text-paper-100">
          <Lightbulb class="w-6 h-6 text-amber-400" />
          Quick Wins
        </h2>
        <p class="text-paper-200/60 mb-6">Easy to fix. Start here for momentum.</p>
        <div id="quick-wins" class="space-y-4"></div>
      </section>

      <!-- What You're Doing Right -->
      <section id="doing-well-section" class="mb-12">
        <h2 class="text-2xl font-bold mb-2 flex items-center gap-3 text-paper-100">
          <CheckCircle2 class="w-6 h-6 text-emerald-400" />
          What You're Doing Right
        </h2>
        <p class="text-paper-200/60 mb-6">Keep it up!</p>
        <div id="doing-well" class="space-y-2"></div>
      </section>

      <!-- CTA -->
      <div class="dark-card border-cyan-500/20 p-8 text-center">
        <h2 class="text-2xl font-bold mb-4 text-paper-100">Ready to Close the Gaps?</h2>
        <p class="text-paper-200/60 mb-6 max-w-2xl mx-auto">
          Click "Help me Automate This" on any gap above to get step-by-step instructions.
          Most take less than 15 minutes to set up.
        </p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <a href="/" class="bg-navy-800 hover:bg-navy-700 text-paper-100 font-semibold px-6 py-3 rounded-lg transition-colors border border-navy-600">
            Retake Assessment
          </a>
          <a href="/guides" class="btn-cta px-6 py-3 rounded-lg">
            Browse All Guides
          </a>
        </div>
      </div>

      <!-- Share -->
      <div class="mt-12 text-center">
        <p class="text-paper-200/50">
          Know another business owner who could use this?
          <button 
            onclick="navigator.share ? navigator.share({title: 'Business Assessment', url: window.location.origin}) : navigator.clipboard.writeText(window.location.origin).then(() => alert('Link copied!'))"
            class="text-cyan-400 hover:underline"
          >
            Share this tool
          </button>
        </p>
      </div>

    </div>

  </main>

  <script define:vars={{ categoryIconMap, allTrades, allBaseCategories, allTradeSpecific }}>
    // Get all items for a trade
    function getAllItems(tradeId) {
      const items = {};
      
      allBaseCategories.forEach(cat => {
        cat.items.forEach(item => {
          items[item.id] = { ...item, category: cat.name, categoryIcon: categoryIconMap[cat.name] || '' };
        });
      });
      
      const specific = allTradeSpecific[tradeId];
      if (specific) {
        specific.forEach(addition => {
          const cat = allBaseCategories.find(c => c.id === addition.category);
          const catName = cat?.name || addition.category;
          addition.items.forEach(item => {
            items[item.id] = { ...item, category: catName, categoryIcon: categoryIconMap[catName] || '' };
          });
        });
      }
      
      return items;
    }

    // Load results from sessionStorage
    const stored = sessionStorage.getItem('assessment-results');
    
    if (!stored) {
      window.location.href = '/';
    } else {
      const results = JSON.parse(stored);
      const trade = allTrades.find(t => t.id === results.trade);
      const allItems = getAllItems(results.trade);
      
      // Calculate score
      const scorePercent = Math.round((results.earnedWeight / results.totalWeight) * 100);
      
      // Determine grade
      let grade, gradeColor, gradeMessage;
      if (scorePercent >= 90) {
        grade = 'A'; gradeColor = 'text-emerald-600'; 
        gradeMessage = "Outstanding! You're running a top-tier operation.";
      } else if (scorePercent >= 80) {
        grade = 'B'; gradeColor = 'text-emerald-600';
        gradeMessage = "Great job! A few tweaks and you'll be at the top.";
      } else if (scorePercent >= 70) {
        grade = 'C'; gradeColor = 'text-amber-600';
        gradeMessage = "Solid foundation. Some key opportunities to improve.";
      } else if (scorePercent >= 50) {
        grade = 'D'; gradeColor = 'text-orange-600';
        gradeMessage = "Room for improvement. The good news? Lots of quick wins available.";
      } else {
        grade = 'F'; gradeColor = 'text-red-600';
        gradeMessage = "Major opportunities ahead. Let's fix the critical gaps first.";
      }
      
      // Populate the page
      document.getElementById('trade-icon').textContent = trade?.icon || 'ðŸ ';
      document.getElementById('trade-name').textContent = trade?.name || 'Home Service';
      document.getElementById('trade-name-2').textContent = trade?.name.toLowerCase() || 'home service';
      document.getElementById('score-percent').textContent = `${scorePercent}%`;
      document.getElementById('checked-count').textContent = results.checkedCount;
      document.getElementById('total-items').textContent = results.totalItems;
      document.getElementById('grade').textContent = grade;
      document.getElementById('grade').className = `text-6xl font-extrabold mb-2 ${gradeColor}`;
      document.getElementById('grade-message').textContent = gradeMessage;
      
      // Animate score bar
      setTimeout(() => {
        document.getElementById('score-bar').style.width = `${scorePercent}%`;
      }, 100);
      
      // Render gaps
      const criticalGaps = [];
      const quickWins = [];
      
      results.unchecked.forEach(itemId => {
        const item = allItems[itemId];
        if (!item) return;
        
        if (item.weight === 3) {
          criticalGaps.push(item);
        } else {
          quickWins.push(item);
        }
      });
      
      function renderGapCard(item) {
        const hasGuide = item.aiSolution && !['habit', 'idea'].includes(item.solutionType);
        return `
          <div class="paper-card p-5">
            <div class="flex items-start justify-between gap-4 mb-2">
              <h3 class="font-semibold text-navy-900">${item.text}</h3>
              <span class="text-xs text-navy-500 flex-shrink-0 flex items-center gap-1">
                <span class="w-4 h-4">${item.categoryIcon}</span>
                ${item.category}
              </span>
            </div>
            <p class="text-navy-600 text-sm mb-4">${item.why}</p>
            ${hasGuide ? `
              <a href="/guide/${item.aiSolution}" class="inline-flex items-center btn-cta px-4 py-2 text-sm">
                Help me Automate This â†’
              </a>
            ` : `
              <span class="text-navy-400 text-sm">Guide coming soon</span>
            `}
          </div>
        `;
      }
      
      document.getElementById('critical-gaps').innerHTML = criticalGaps.length 
        ? criticalGaps.map(renderGapCard).join('')
        : '<p class="text-paper-200/50">No critical gaps! ðŸŽ‰</p>';
        
      document.getElementById('quick-wins').innerHTML = quickWins.length
        ? quickWins.map(renderGapCard).join('')
        : '<p class="text-paper-200/50">No quick wins remaining!</p>';
      
      // Render what they're doing well
      const doingWell = results.checked.map(id => allItems[id]).filter(Boolean);
      document.getElementById('doing-well').innerHTML = doingWell.length
        ? doingWell.map(item => `
            <div class="flex items-center gap-3 text-paper-200/70">
              <svg class="w-5 h-5 text-emerald-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
              <span>${item.text}</span>
            </div>
          `).join('')
        : '<p class="text-paper-200/50">Complete the assessment to see what you\'re doing well.</p>';
      
      // Hide sections if empty
      if (criticalGaps.length === 0) {
        document.getElementById('critical-gaps-section').classList.add('hidden');
      }
      if (quickWins.length === 0) {
        document.getElementById('quick-wins-section').classList.add('hidden');
      }
      
      // Show results, hide loading
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('results-content').classList.remove('hidden');
    }
  </script>
</Layout>
